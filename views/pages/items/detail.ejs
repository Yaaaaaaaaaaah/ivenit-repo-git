<%- include('../../partials/header', { title: `Detail Aset` }) %>

<%# ============================================================= %>
<%# --- JUDUL HALAMAN DAN TOMBOL AKSI --- %>
<%# ============================================================= %>
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h4 mb-1 fw-semibold text-primary"><%= item.name %></h1>
        <span class="small text-muted">Detail Aset</span>
    </div>
    <div>
        <% if (session && session.userId) { %>
            <a href="/items/<%= item.id %>/edit" class="btn btn-warning btn-sm rounded-pill">
                <i class="bi bi-pencil-square me-1"></i> Edit Aset
            </a>
        <% } %>
        <a href="/" class="btn btn-outline-secondary btn-sm rounded-pill ms-2">
            <i class="bi bi-arrow-left-circle me-1"></i> Kembali
        </a>
    </div>
</div>

<%# ============================================================= %>
<%# --- KONTEN UTAMA DENGAN TAB --- %>
<%# ============================================================= %>
<div class="row g-4">

    <%# --- KOLOM KIRI (Info Utama & Gambar) --- %>
    <div class="col-lg-4">
        <div class="card shadow-sm mb-4">
            <div class="card-body p-3 text-center">

                <%# ============================================= %>
                <%# ===== PERBAIKAN GAMBAR (CLOUDINARY + LOCAL) ===== %>
                <%# ============================================= %>
                <%
                let detailImagePath = item.image_url;
                if (detailImagePath) {
                    detailImagePath = detailImagePath.trim();
                    // Jika bukan URL penuh, tambahkan '/' agar bisa diakses dari public path
                    if (!detailImagePath.startsWith('http')) {
                        detailImagePath = (detailImagePath.startsWith('/') ? '' : '/') + detailImagePath;
                    }
                } else {
                    // Jika tidak ada gambar sama sekali
                    detailImagePath = '/images/placeholder-image.webp';
                }
                %>

                <img src="<%= detailImagePath %>" alt="<%= item.name %>"
                    class="img-fluid rounded mb-3"
                    style="max-height: 350px; width: 100%; object-fit: cover;">

                <%# Status Aset %>
                <% if(item.availability_status === 'Tersedia') { %>
                    <span class="badge fs-6 text-bg-success-subtle text-success-emphasis fw-medium">
                        <i class="bi bi-check-circle-fill me-1"></i> <%= item.availability_status %>
                    </span>
                <% } else if(item.availability_status === 'Dipinjam') { %>
                    <span class="badge fs-6 text-bg-warning-subtle text-warning-emphasis fw-medium">
                        <i class="bi bi-arrow-left-right me-1"></i> <%= item.availability_status %>
                    </span>
                <% } else { %>
                    <span class="badge fs-6 text-bg-danger-subtle text-danger-emphasis fw-medium">
                        <i class="bi bi-tools me-1"></i> <%= item.availability_status %>
                    </span>
                <% } %>

                <hr class="my-3">
                <div class="small text-start">
                    <p class="mb-2">
                        <strong class="text-muted d-block">Kategori:</strong>
                        <span class="badge text-bg-primary rounded-pill fw-normal">
                            <%= item.category ? item.category.name : 'N/A' %>
                        </span>
                    </p>
                    <p class="mb-2"><strong class="text-muted d-block">Model:</strong> <%= item.model || '-' %></p>
                    <p class="mb-2"><strong class="text-muted d-block">S/N:</strong> <%= item.serial_number || '-' %></p>
                    <p class="mb-0"><strong class="text-muted d-block">No. Inventaris:</strong> <%= item.no_inventaris || '-' %></p>
                </div>
            </div>
        </div>
    </div>

    <%# --- KOLOM KANAN (Tabs) --- %>
    <div class="col-lg-8">
        <div class="card shadow-sm">
            <div class="card-header p-0 border-bottom-0">
                <%# --- Navigasi Tab --- %>
                <ul class="nav nav-tabs nav-tabs-responsive" id="assetDetailTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="details-tab" data-bs-toggle="tab"
                            data-bs-target="#details-tab-pane" type="button" role="tab"
                            aria-controls="details-tab-pane" aria-selected="true">
                            <i class="bi bi-info-circle-fill me-1"></i> Detail
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="specs-tab" data-bs-toggle="tab"
                            data-bs-target="#specs-tab-pane" type="button" role="tab"
                            aria-controls="specs-tab-pane" aria-selected="false">
                            <i class="bi bi-cpu-fill me-1"></i> Spesifikasi
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="history-tab" data-bs-toggle="tab"
                            data-bs-target="#history-tab-pane" type="button" role="tab"
                            aria-controls="history-tab-pane" aria-selected="false">
                            <i class="bi bi-tools me-1"></i> Riwayat Perawatan
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="loans-tab" data-bs-toggle="tab"
                            data-bs-target="#loans-tab-pane" type="button" role="tab"
                            aria-controls="loans-tab-pane" aria-selected="false">
                            <i class="bi bi-person-lines-fill me-1"></i> Riwayat Peminjaman
                        </button>
                    </li>
                </ul>
            </div>

            <div class="card-body p-4 small">
                <div class="tab-content" id="assetDetailTabsContent">

                    <%# ============================================================= %>
                    <%# --- TAB 1: DETAIL UMUM --- %>
                    <%# ============================================================= %>
                    <div class="tab-pane fade show active" id="details-tab-pane" role="tabpanel"
                        aria-labelledby="details-tab" tabindex="0">
                        <h6 class="fw-semibold mb-3">Informasi Umum & Pembelian</h6>
                        <table class="table table-sm table-borderless mb-0">
                            <tbody>
                                <tr><td class="fw-medium text-muted" style="width: 35%;">Nama Aset</td><td>: <%= item.name %></td></tr>
                                <% if(item.host_pc_name) { %>
                                    <tr><td class="fw-medium text-muted">Host PC Name</td><td>: <%= item.host_pc_name %></td></tr>
                                <% } %>
                                <tr><td class="fw-medium text-muted">PIC / Pengguna</td><td>: <%= item.pic_name || '-' %></td></tr>
                                <% if(item.category && item.category.name === 'Laptop/PC') { %>
                                    <tr><td class="fw-medium text-muted">Departemen</td><td>: <%= item.department ? item.department.name : '-' %></td></tr>
                                <% } else { %>
                                    <tr><td class="fw-medium text-muted">Lokasi</td><td>: <%= item.location ? item.location.name : '-' %></td></tr>
                                <% } %>
                                <tr><td class="fw-medium text-muted">Tanggal Beli</td><td>: <%= item.purchase_date ? new Date(item.purchase_date).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' }) : '-' %></td></tr>
                                <tr>
                                    <td class="fw-medium text-muted">Kondisi</td>
                                    <td>:
                                        <% if(item.condition === 'Baik') { %>
                                            <span class="badge text-bg-success fw-normal"><i class="bi bi-check-circle me-1"></i> <%= item.condition %></span>
                                        <% } else if(item.condition === 'Rusak Ringan' || item.condition === 'Rusak') { %>
                                            <span class="badge text-bg-warning fw-normal"><i class="bi bi-exclamation-triangle me-1"></i> <%= item.condition %></span>
                                        <% } else { %>
                                            <span class="badge text-bg-secondary fw-normal"><%= item.condition %></span>
                                        <% } %>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="fw-medium text-muted" style="vertical-align: top;">Catatan</td>
                                    <td style="vertical-align: top;">: <%= item.notes || '-' %></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <%# ============================================================= %>
                    <%# --- TAB 2: SPESIFIKASI TEKNIS --- %>
                    <%# ============================================================= %>
                    <div class="tab-pane fade" id="specs-tab-pane" role="tabpanel"
                        aria-labelledby="specs-tab" tabindex="0">
                        <h6 class="fw-semibold mb-3">Spesifikasi Teknis</h6>
                        <% if(item.specifications && item.specifications.length > 0) { %>
                            <table class="table table-sm table-striped table-bordered mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 40%;">Properti</th>
                                        <th>Nilai</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% item.specifications.forEach(spec => { %>
                                        <tr>
                                            <td class="fw-medium"><%= spec.spec_key %></td>
                                            <td><%= spec.spec_value %></td>
                                        </tr>
                                    <% }) %>
                                </tbody>
                            </table>
                        <% } else { %>
                            <p class="text-muted fst-italic text-center m-0">Tidak ada data spesifikasi teknis.</p>
                        <% } %>
                    </div>

                    <%# ============================================================= %>
                    <%# --- TAB 3: RIWAYAT PERAWATAN --- %>
                    <%# ============================================================= %>
                    <div class="tab-pane fade" id="history-tab-pane" role="tabpanel"
                        aria-labelledby="history-tab" tabindex="0">
                        <h6 class="fw-semibold mb-3">Riwayat Perawatan & Maintenance</h6>
                        <ul class="list-group list-group-flush">
                            <% if(item.logs && item.logs.length > 0) { %>
                                <% item.logs.forEach(log => { %>
                                    <li class="list-group-item d-flex justify-content-between align-items-start px-0 py-2 border-bottom">
                                        <div class="small w-100">
                                            <div class="text-muted mb-1 d-flex justify-content-between">
                                                <span><i class="bi bi-calendar-event me-1"></i><%= new Date(log.activity_date).toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' }) %></span>
                                                <span><i class="bi bi-person-fill me-1"></i><%= log.technician_name || 'N/A' %></span>
                                            </div>
                                            <%= log.description %>
                                        </div>
                                    </li>
                                <% }) %>
                            <% } else { %>
                                <li class="list-group-item text-center text-muted fst-italic px-0 py-3 small">Belum ada riwayat perawatan.</li>
                            <% } %>
                        </ul>
                    </div>

                    <%# ============================================================= %>
                    <%# --- TAB 4: RIWAYAT PEMINJAMAN --- %>
                    <%# ============================================================= %>
                    <div class="tab-pane fade" id="loans-tab-pane" role="tabpanel"
                        aria-labelledby="loans-tab" tabindex="0">
                        <h6 class="fw-semibold mb-3">Riwayat Peminjaman</h6>
                        <p class="text-muted fst-italic text-center m-0">(Fitur ini akan menampilkan riwayat peminjaman aset)</p>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<%- include('../../partials/footer') %>
